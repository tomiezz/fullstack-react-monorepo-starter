image: docker:20
services:
  - docker:dind
stages:
  - prepare
  - build
  - deploy

variables:
  WEB_IMG_NAME: "frms-web"

before_script:
  - chmod +x ./scripts/get-env.sh
  - source ./scripts/get-env.sh

.docker_authentication:
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build web:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "stag" || $CI_COMMIT_TAG
      changes:
        - "packages/web/**/*"
        - "packages/shared/**/*"
  variables:
    IMG_NAME: "${CI_REGISTRY_IMAGE}/${WEB_IMG_NAME}"
    DOCKER_FILE_PATH: "./docker/Dockerfile.base"
  script:
    - chmod +x ./scripts/build-img.sh
    - ./scripts/build-img.sh
